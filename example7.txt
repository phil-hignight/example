<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pastable API Test - All-in-One</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #0d1117;
      color: #e6edf3;
    }
    .container {
      background: #161b22;
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
    }
    h1 {
      color: #58a6ff;
      margin-top: 0;
    }
    h2 {
      color: #58a6ff;
      border-bottom: 1px solid #30363d;
      padding-bottom: 10px;
    }
    button {
      background: #238636;
      border: 1px solid #2ea043;
      color: white;
      padding: 10px 20px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #2ea043;
    }
    button.secondary {
      background: #21262d;
      border: 1px solid #30363d;
      color: #e6edf3;
    }
    button.secondary:hover {
      background: #30363d;
    }
    .log {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 12px;
      margin-top: 12px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .success {
      color: #3fb950;
    }
    .error {
      color: #f85149;
    }
    .info {
      color: #58a6ff;
    }
    .warning {
      color: #d29922;
    }
  </style>
</head>
<body>
  <h1>üß™ Pastable API Test Suite</h1>

  <div class="container">
    <h2>Test Controls</h2>
    <p>This page tests the pastable agent with an interceptor to compare requests.</p>
    <button onclick="runWorkingExample()">1. Run Working Example</button>
    <button onclick="runPastableApp()">2. Run Pastable App</button>
    <button class="secondary" onclick="clearLog()">Clear Log</button>
    <button class="secondary" onclick="showCapturedRequests()">Show Captured Requests</button>
  </div>

  <div class="container">
    <h2>Console Output</h2>
    <div id="log" class="log">Ready. Click a button above to start testing.</div>
  </div>

  <script>
    // ========================================================================
    // LOGGING UTILITIES
    // ========================================================================
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const className = type;
      const line = `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      logDiv.innerHTML += line;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function clearLog() {
      document.getElementById('log').innerHTML = 'Log cleared.\n';
    }

    // ========================================================================
    // FETCH INTERCEPTOR
    // ========================================================================
    const capturedRequests = [];
    const originalFetch = window.fetch;

    window.fetch = async function(...args) {
      const [url, options = {}] = args;

      // Only intercept widgetCreateSession requests
      if (url && url.includes('widgetCreateSession')) {
        log('üì° Intercepted widgetCreateSession request', 'info');

        const requestBody = options.body;
        const requestBodyString = typeof requestBody === 'string' ? requestBody : JSON.stringify(requestBody);

        const charLength = requestBodyString.length;
        const byteLength = new TextEncoder().encode(requestBodyString).length;
        const buffer = new TextEncoder().encode(requestBodyString);

        const capturedRequest = {
          timestamp: Date.now(),
          url,
          method: options.method,
          headers: options.headers,
          body: requestBodyString,
          charLength,
          byteLength,
          buffer: Array.from(buffer)
        };

        capturedRequests.push(capturedRequest);

        log(`Request #${capturedRequests.length}`, 'info');
        log(`  Char length: ${charLength}`, 'info');
        log(`  Byte length: ${byteLength}`, 'info');
        log(`  Body: ${requestBodyString}`, 'info');

        // If we have 2+ requests, compare them
        if (capturedRequests.length >= 2) {
          log('‚ïê'.repeat(60), 'warning');
          log('üî¨ COMPARING REQUESTS', 'warning');
          log('‚ïê'.repeat(60), 'warning');

          const req1 = capturedRequests[0];
          const req2 = capturedRequests[capturedRequests.length - 1];

          log(`Request 1: ${req1.charLength} chars, ${req1.byteLength} bytes`, 'info');
          log(`Request 2: ${req2.charLength} chars, ${req2.byteLength} bytes`, 'info');
          log(`Difference: ${req2.charLength - req1.charLength} chars, ${req2.byteLength - req1.byteLength} bytes`, 'warning');
          log(`Bodies equal: ${req1.body === req2.body}`, req1.body === req2.body ? 'success' : 'error');

          if (req1.body !== req2.body) {
            log('‚ùå BODIES ARE DIFFERENT!', 'error');

            // Find differences
            const maxLen = Math.max(req1.body.length, req2.body.length);
            for (let i = 0; i < maxLen; i++) {
              if (req1.body[i] !== req2.body[i]) {
                log(`First difference at position ${i}:`, 'error');
                log(`  Req1: '${req1.body[i]}' (code: ${req1.body[i]?.charCodeAt(0) ?? 'EOF'})`, 'error');
                log(`  Req2: '${req2.body[i]}' (code: ${req2.body[i]?.charCodeAt(0) ?? 'EOF'})`, 'error');

                const start = Math.max(0, i - 20);
                const end = Math.min(maxLen, i + 20);
                log(`  Req1 context: "${req1.body.slice(start, end)}"`, 'error');
                log(`  Req2 context: "${req2.body.slice(start, end)}"`, 'error');
                break;
              }
            }
          } else {
            log('‚úÖ BODIES ARE IDENTICAL!', 'success');
          }

          log('‚ïê'.repeat(60), 'warning');
        }
      }

      // Call original fetch
      return originalFetch.apply(this, args);
    };

    log('‚úÖ Fetch interceptor installed', 'success');

    // ========================================================================
    // WORKING EXAMPLE
    // ========================================================================
    async function runWorkingExample() {
      log('‚ïê'.repeat(60), 'info');
      log('üöÄ Running Working Example', 'info');
      log('‚ïê'.repeat(60), 'info');

      const configId = "f5df5665-52d6-4e1b-8f7d-ddbb6a2fd450d";
      const createSessionUrl = "https://content-us-discoveryengine.googleapis.com/v1alpha/locations/us/widgetCreateSession";

      try {
        const response = await fetch(createSessionUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            configId: configId,
            additionalParams: { token: "-" },
            createSessionRequest: { session: { name: "-", displayName: "" } },
          }),
        });

        if (!response.ok) {
          const errorText = await response.text();
          log(`‚ùå Working example failed: ${response.status}`, 'error');
          log(`Error: ${errorText}`, 'error');
          return;
        }

        let responseText = await response.text();
        if (responseText.startsWith(')]}"')) {
          responseText = responseText.substring(5);
        }

        const data = JSON.parse(responseText);
        log(`‚úÖ Working example succeeded!`, 'success');
        log(`Session: ${data.session?.name || 'N/A'}`, 'success');

      } catch (error) {
        log(`‚ùå Working example error: ${error.message}`, 'error');
      }

      log('‚ïê'.repeat(60), 'info');
    }

    // ========================================================================
    // PASTABLE APP (Simplified - just the initialize part)
    // ========================================================================
    async function runPastableApp() {
      log('‚ïê'.repeat(60), 'info');
      log('üöÄ Running Pastable App', 'info');
      log('‚ïê'.repeat(60), 'info');

      const CONFIG_ID = "f5df5665-52d6-4e1b-8f7d-ddbb6a2fd450d";
      const CREATE_SESSION_URL = "https://content-us-discoveryengine.googleapis.com/v1alpha/locations/us/widgetCreateSession";

      try {
        const requestBody = JSON.stringify({
          configId: CONFIG_ID,
          additionalParams: { token: "-" },
          createSessionRequest: { session: { name: "-", displayName: "" } }
        });

        log(`[AI] Request body length: ${requestBody.length}`, 'info');
        log(`[AI] Request body bytes: ${new TextEncoder().encode(requestBody).length}`, 'info');

        const response = await fetch(CREATE_SESSION_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: requestBody
        });

        if (!response.ok) {
          const errorText = await response.text();
          log(`‚ùå Pastable app failed: ${response.status}`, 'error');
          log(`Error: ${errorText}`, 'error');
          return;
        }

        let responseText = await response.text();
        if (responseText.startsWith(')]}"')) {
          responseText = responseText.substring(5);
        }

        const data = JSON.parse(responseText);
        log(`‚úÖ Pastable app succeeded!`, 'success');
        log(`Session: ${data.session?.name || 'N/A'}`, 'success');

      } catch (error) {
        log(`‚ùå Pastable app error: ${error.message}`, 'error');
      }

      log('‚ïê'.repeat(60), 'info');
    }

    // ========================================================================
    // UTILITY FUNCTIONS
    // ========================================================================
    function showCapturedRequests() {
      log('‚ïê'.repeat(60), 'info');
      log(`üìä Captured ${capturedRequests.length} request(s)`, 'info');

      capturedRequests.forEach((req, idx) => {
        log(`\nRequest #${idx + 1}:`, 'info');
        log(`  Timestamp: ${new Date(req.timestamp).toLocaleTimeString()}`, 'info');
        log(`  Char length: ${req.charLength}`, 'info');
        log(`  Byte length: ${req.byteLength}`, 'info');
        log(`  Body: ${req.body}`, 'info');
      });

      log('‚ïê'.repeat(60), 'info');
    }

    // Expose for console access
    window.__capturedRequests = capturedRequests;
  </script>
</body>
</html>
