(async () => {
  const configId = "f5df5665-52d6-4e1b-8f7d-ddbb6a2fd450d";
  const createSessionUrl =
    "https://content-us-discoveryengine.googleapis.com/v1alpha/locations/us/widgetCreateSession";
  const streamAssistUrl =
    "https://content-us-discoveryengine.googleapis.com/v1alpha/locations/us/widgetStreamAssist";

  const postApi = async (url, body) => {
    const response = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });
    if (!response.ok) throw new Error(`API request failed: ${response.status}`);
    let responseText = await response.text();
    if (responseText.startsWith(')]}"')) {
      responseText = responseText.substring(5);
    }
    return JSON.parse(responseText);
  };

  const streamAndProcess = async (url, body) => {
    const response = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body),
    });
    if (!response.ok)
      throw new Error(`Streaming request failed: ${response.status}`);
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let fullResponseText = "";

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      fullResponseText += decoder.decode(value);
    }

    if (fullResponseText.startsWith(')]}"')) {
      fullResponseText = fullResponseText.substring(5);
    }
    const parsedData = JSON.parse(fullResponseText);
    return Array.isArray(parsedData) ? parsedData : [parsedData];
  };

  const getReplyText = (responseArray) => {
    let fullText = "";
    for (const chunk of responseArray) {
      const replies = chunk?.streamAssistResponse?.answer?.replies;
      if (replies) {
        for (const reply of replies) {
          const text = reply?.groundedContent?.content?.text;
          if (text && !reply?.groundedContent?.content?.thought) {
            fullText += text;
          }
        }
      }
    }
    return fullText.replace(/\\n/g, "\n").trim();
  };

  try {
    const sessionResponse = await postApi(createSessionUrl, {
      configId: configId,
      additionalParams: { token: "-" },
      createSessionRequest: { session: { name: "-", displayName: "" } },
    });
    const sessionName = sessionResponse.session.name;
    if (!sessionName) throw new Error("Failed to get session name.");

    await streamAndProcess(streamAssistUrl, {
      configId: configId,
      additionalParams: { token: "-" },
      streamAssistRequest: {
        session: sessionName,
        query: { parts: [{ text: "My name is John." }] },
      },
    });

    const secondResponse = await streamAndProcess(streamAssistUrl, {
      configId: configId,
      additionalParams: { token: "-" },
      streamAssistRequest: {
        session: sessionName,
        query: { parts: [{ text: "What is my name?" }] },
      },
    });
    const secondReply = getReplyText(secondResponse);

    console.log(`--- TEST RESULT ---`);
    console.log(`AI's final answer to "What is my name?":\n"${secondReply}"`);

    if (secondReply.toLowerCase().includes("john")) {
      console.log(
        "✅ SUCCESS: The AI remembered the name 'John', proving the conversation is stateful."
      );
    } else {
      console.log(
        "❌ FAILURE: The AI did not remember the name or the text was not extracted correctly."
      );
    }
  } catch (error) {
    console.error("An error occurred during the replication:", error.message);
  }
})();
